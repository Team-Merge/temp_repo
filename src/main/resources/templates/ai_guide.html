<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>AI 음성 가이드</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f0f0f0;
        }
        #chatContainer {
            display: flex;
            flex-direction: column;
            margin: 20px;
        }
        #messagesContainer {
            flex: 1;
            overflow-y: auto;
            margin-bottom: 20px;
            height: 70vh; /* 화면의 70% 만큼의 높이 */
        }
        #userInputContainer {
            display: flex;
            align-items: center;
            background-color: white;
            padding: 10px;
            border-radius: 5px;
            border: 1px solid #ccc;
        }
        #textQuestion {
            flex: 1;
            padding: 10px;
            border: none;
            border-radius: 5px;
        }
        #sendButton, #recordButton, #textQuestionButton {
            background-color: #4CAF50;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            margin-left: 10px;
        }
        #sendButton {
            background-color: #007bff;
        }
        .message {
            background-color: #d9f7be;
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
            max-width: 70%;
        }
        .message.bot {
            background-color: #e1e1e1;
            align-self: flex-start;
        }
        .message.user {
            background-color: #cce4ff;
            align-self: flex-end;
        }
        #audioPlayback {
            width: 100%;
            display: none;  /* 음성 파일이 재생될 때만 나타나도록 설정 */
        }
        #audioContainer {
            margin-top: 10px;
            display: none;
        }
        #recordButtonActive {
            background-color: #f44336;  /* 빨간색 버튼으로 변경 */
        }
        #recordButton {
            background-color: #4CAF50;  /* 기본 버튼 색상 */
        }
        #loadMoreButton {
            background-color: #007bff;
            color: white;
            padding: 10px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            margin-top: 10px;
        }
    </style>
</head>
<body>

<div id="chatContainer">
    <button id="loadMoreButton">더보기</button> <!-- 더보기 버튼 추가 -->
    <div id="messagesContainer"></div>
    <div id="userInputContainer">
        <input type="text" id="textQuestion" placeholder="질문을 입력하세요" />
        <button id="sendButton">전송</button>
        <button id="recordButton">녹음 시작</button>
        <button id="textQuestionButton" style="display:none;">텍스트질문</button>
    </div>
    <div id="audioContainer">
        <audio id="audioPlayback"></audio>
    </div>
</div>

<script>
    document.addEventListener("DOMContentLoaded", function () {
        const jwtToken = localStorage.getItem("jwt");  // 로컬스토리지에서 JWT 토큰을 가져옴

        if (!jwtToken || jwtToken === "undefined") {
            console.log("JWT 토큰 없음. 로그인 필요.");
            alert("로그인 후 사용해주세요.");
            return;
        }

        const sendButton = document.getElementById("sendButton");
        const recordButton = document.getElementById("recordButton");
        const textQuestionInput = document.getElementById("textQuestion");
        const messagesContainer = document.getElementById("messagesContainer");
        const audioContainer = document.getElementById("audioContainer");
        const audioPlayback = document.getElementById("audioPlayback");
        const loadMoreButton = document.getElementById("loadMoreButton");
        const textQuestionButton = document.getElementById("textQuestionButton");

        let mediaRecorder;
        let audioChunks = [];
        let currentTranscript = "";  // 실시간으로 변환된 텍스트를 저장할 변수
        let recognition;  // 음성 인식 변수
        let isRecording = false;  // 녹음 상태
        let offset = 0; // 대화 기록의 시작 offset
        const limit = 5; // 한 번에 불러올 대화 기록의 개수

// 이전 대화 기록을 불러오기
        async function loadChatHistory() {
            const response = await fetch(`/api/ai-guide/get-chat-history?offset=${offset}&limit=${limit}`, {
                method: "GET",
                headers: { "Authorization": "Bearer " + jwtToken }
            });
            const data = await response.json();

            if (data && data.length > 0) {
                // 데이터를 순서대로 받았기 때문에 최신 대화가 맨 아래에 존재
                // 위로 쌓이도록 하기 위해 순서를 반대로 바꿈
                data.forEach(item => {
                    const messageElement = document.createElement("div");
                    messageElement.classList.add("message", "bot");
                    messageElement.textContent = 'A: ' + item.conversationAnswer;
                    messagesContainer.insertBefore(messageElement, messagesContainer.firstChild); // 맨 위에 추가

                    const questionElement = document.createElement("div");
                    questionElement.classList.add("message", "user");
                    questionElement.textContent = 'Q: ' + item.conversationQuestion;
                    messagesContainer.insertBefore(questionElement, messagesContainer.firstChild); // 맨 위에 추가
                });

                // offset 증가
                offset += data.length;  // 받은 대화 기록 수만큼 offset 증가

                // 더보기 버튼을 숨김
                if (data.length < limit) {
                    loadMoreButton.style.display = "none";  // 더 이상 대화 기록이 없으면 버튼 숨김
                } else {
                    loadMoreButton.style.display = "block";  // 여전히 더 많은 대화가 있으면 버튼 표시
                }

                // 스크롤을 가장 위로 이동
                messagesContainer.scrollTop = 0;  // 위로 스크롤 이동
            } else {
                loadMoreButton.style.display = "none";  // 데이터가 없으면 버튼 숨김
            }
        }

// 페이지 로드 시 이전 대화 기록 불러오기
        loadChatHistory();


        // "더보기" 버튼 클릭 시 더 많은 대화 기록을 불러오기
        loadMoreButton.onclick = async () => {
            loadMoreButton.disabled = true;
            await loadChatHistory();
            loadMoreButton.disabled = false;
        };

        // 텍스트 질문 제출
        sendButton.onclick = async () => {
            const textQuestion = textQuestionInput.value;
            displayMessage({ type: "user", text: `Q: ${textQuestion}` });

            if (!textQuestion) {
                alert("질문을 입력하세요.");
                return;
            }

            const requestData = { user_question: textQuestion };

            // 텍스트 입력칸 초기화
            textQuestionInput.value = "";

            const response = await fetch("/api/ai-guide/upload-text", {
                method: "POST",
                headers: { "Authorization": "Bearer " + jwtToken, "Content-Type": "application/json" },
                body: JSON.stringify(requestData)
            });

            const data = await response.json();
            displayResponse(data);
        };

        // 녹음 시작
        recordButton.onclick = async () => {
            // 음성 재생 중일 경우, 재생을 멈추고 초기화
            audioPlayback.pause();
            audioPlayback.currentTime = 0;


            if (!isRecording) {
                // 녹음 시작 시 전송 버튼 숨기고 텍스트질문 버튼 보이기
                sendButton.style.display = "none";
                textQuestionButton.style.display = "inline-block"; // 텍스트질문 버튼 보이기

                recordButton.textContent = "녹음 종료";
                recordButton.classList.add("recordButtonActive");

                audioContainer.style.display = "block";  // 오디오 컨트롤 보여주기
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                mediaRecorder = new MediaRecorder(stream);
                audioChunks = [];

                // 음성 인식
                recognition = new webkitSpeechRecognition();
                recognition.lang = "ko-KR";
                recognition.interimResults = true;
                recognition.start();

                recognition.onresult = (event) => {
                    currentTranscript = event.results[0][0].transcript;
                    textQuestionInput.value = currentTranscript;  // 텍스트 입력란에 표시
                };

                mediaRecorder.ondataavailable = event => {
                    audioChunks.push(event.data);
                };

                mediaRecorder.onstop = async () => {
                    const audioBlob = new Blob(audioChunks, { type: 'audio/wav' });
                    const audioUrl = URL.createObjectURL(audioBlob);

                    // 이전의 음성 파일을 멈추고 새로운 파일을 로드
                    audioPlayback.pause();
                    audioPlayback.currentTime = 0;
                    audioPlayback.src = audioUrl;

                    const formData = new FormData();
                    formData.append("audio", audioBlob, "audio.wav");

                    const response = await fetch("/api/ai-guide/upload-audio", {
                        method: "POST",
                        headers: { "Authorization": "Bearer " + jwtToken },
                        body: formData
                    });

                    const data = await response.json();
                    displayResponse(data);
                };

                mediaRecorder.start();
                isRecording = true;
            }
        };

        // 텍스트질문 버튼 클릭 시 초기 상태로 돌아가기
        textQuestionButton.onclick = () => {
            textQuestionButton.style.display = "none";  // 텍스트질문 버튼 숨기기
            sendButton.style.display = "inline-block";  // 전송 버튼 보이기
            textQuestionInput.value = "";  // 입력창 초기화
        };

        // 녹음 종료
        recordButton.addEventListener('click', function () {
            if (isRecording) {
                mediaRecorder.stop();  // 음성 녹음 종료
                recognition.stop();  // 음성 인식 종료

                // 텍스트 입력칸 초기화
                textQuestionInput.value = "";

                // 변환된 텍스트를 채팅방에 추가
                const userMessage = document.createElement("div");
                userMessage.classList.add("message", "user");
                userMessage.textContent = `Q: ${currentTranscript}`;
                messagesContainer.appendChild(userMessage);
                messagesContainer.scrollTop = messagesContainer.scrollHeight;

                // 버튼 스타일 초기화
                recordButton.textContent = "녹음 시작";
                recordButton.classList.remove("recordButtonActive");

                isRecording = false;  // 녹음 상태를 false로 변경
                sendButton.style.display = "inline-block";  // 전송 버튼 보이기
                textQuestionButton.style.display = "none";  // 텍스트질문 버튼 숨기기
            }
        });

        // 서버 응답 처리
        function displayResponse(data) {
            if (data.error) {
                displayMessage({ type: "bot", text: `Error: ${data.error}` });
            } else {
                const answer = data.conversation_history.history[0].assistant_response || "No answer provided.";
                displayMessage({ type: "bot", text: `A: ${answer}` });

                // 이전 음성 정지 후 새로운 음성 로드
                if (!audioPlayback.paused) {

                    audioPlayback.pause();
                    audioPlayback.currentTime = 0;
                }

                if (data.file_url) {
                    // 음성 파일을 새로 로드하고 재생
                    audioPlayback.src = data.file_url;
                    console.log(data.file_url)
                    audioPlayback.load();  // 음성을 강제로 로드
                    audioPlayback.style.display = "block";  // 음성 파일 재생 표시
                    audioPlayback.play();  // 바로 재생 시작
                }
            }
        }

        // 사용자 메시지 화면에 표시
        function displayMessage(message) {
            const messageElement = document.createElement("div");
            messageElement.classList.add("message", message.type);
            messageElement.textContent = message.text;
            messagesContainer.appendChild(messageElement);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

    });
</script>

</body>
</html>
