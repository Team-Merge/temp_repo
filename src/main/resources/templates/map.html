<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>네이버 지도</title>
    <script type="text/javascript" src="https://openapi.map.naver.com/openapi/v3/maps.js?ncpClientId=API_KEY"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
        }

        #map-container {
            position: fixed;
            width: 100%;
            height: 400px;
            top: 0;
            left: 0;
            background-color: white;
            z-index: 1000;
            box-shadow: 0px 2px 10px rgba(0, 0, 0, 0.1);
        }

        #map {
            width: 100%;
            height: 100%;
        }

        #place-count {
            position: absolute;
            top: 10px;
            left: 50%;
            transform: translateX(-50%);
            background-color: #4aa3df;
            color: white;
            padding: 10px 20px;
            border-radius: 20px;
            font-weight: bold;
            font-size: 14px;
            z-index: 1000;
        }

        .content-container {
            display: flex;
            flex-direction: row;
            margin-top: 375px;
        }

        .sidebar {
            width: 140px;
            background: #f8f9fa;
            padding: 15px;
            border-right: 1px solid #ddd;
            display: flex;
            flex-direction: column;
            gap: 15px;
            position: fixed;
            left: 0;
            top: 420px;
            height: calc(100% - 420px);
            overflow-y: auto;
        }

        .sidebar button {
            background: none;
            border: none;
            padding: 10px;
            text-align: left;
            font-size: 14px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .sidebar button.active {
            color: #007bff;
            font-weight: bold;
            border-left: 4px solid #007bff;
        }

        .places-container {
            flex: 1;
            padding: 15px;
            margin-left: 160px;
            height: calc(100vh - 420px);
            overflow-y: auto;
            margin-top: 20px;
        }

        .place-item {
            background: white;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
            margin-bottom: 10px;
        }

        .place-item h3 {
            margin: 0;
            font-size: 16px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .place-item p {
            margin: 5px 0;
            color: #666;
            font-size: 14px;
        }

        .place-item .favorite-icon {
            cursor: pointer;
            font-size: 18px;
        }

        #place-details {
        position: absolute;
        left: 160px;
        top: 420px;
        width: calc(100% - 160px);
        height: calc(100vh - 420px);
        background: white;
        padding: 20px;
        box-shadow: 0px 4px 10px rgba(0, 0, 0, 0.1);
        display: none;
        overflow-y: auto;
        }

    </style>
</head>
<body>

<div id="map-container">
    <p id="place-count">지금 내 주변 관광명소는 0개</p>
    <div id="map"></div>
</div>

<div class="content-container">
    <div class="sidebar">
        <button id="custom-places-btn" class="active">맞춤 명소</button>
        <button id="all-places-btn">모든 명소</button>
        <button id="favorites-btn">즐겨찾기</button>
    </div>
    <!-- 명소 리스트 -->
    <div class="places-container">
        <div id="places-list"></div> <!-- 기본 명소 리스트 -->
        <div id="place-details" style="display: none;"></div> <!-- 개별 명소 상세 정보 -->
    </div>
</div>

<script>
    let map, currentMarker;
    let userLatitude = null;
    let userLongitude = null;
    let markers = [];
    let currentPlaces = [];

    document.addEventListener("DOMContentLoaded", function () {
        function initMap() {
            if (navigator.geolocation) {
                navigator.geolocation.watchPosition(updateLocation, handleLocationError, { enableHighAccuracy: true });
            } else {
                alert("이 브라우저는 위치 정보를 지원하지 않습니다.");
            }
        }

        function updateLocation(position) {
            userLatitude = position.coords.latitude;
            userLongitude = position.coords.longitude;

            console.log(`현재 위치 - 위도: ${userLatitude}, 경도: ${userLongitude}`);

            if (!map) {
                map = new naver.maps.Map('map', {
                    center: new naver.maps.LatLng(userLatitude, userLongitude),
                    zoom: 15,
                });
            }

            addCurrentMarker(userLatitude, userLongitude);
            saveUserLocation(userLatitude, userLongitude);
        }

        function addCurrentMarker(latitude, longitude) {
            if (currentMarker) {
                currentMarker.setMap(null);
            }

            currentMarker = new naver.maps.Marker({
                position: new naver.maps.LatLng(latitude, longitude),
                map: map,
                icon: {
                    content: '<div style="width: 14px; height: 14px; background-color: red; opacity: 0.7; border-radius: 50%;"></div>',
                    anchor: new naver.maps.Point(7, 7),
                },
            });
        }

        function saveUserLocation(latitude, longitude) {
            fetch("/location/user-location", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ latitude, longitude }),
            })
                .then((response) => response.json())
                .then((data) => console.log("위치 저장 성공:", data))
                .catch((error) => console.error("Error saving location:", error));
        }

        // 명소 검색 및 지도에 마커 추가
        function fetchNearbyPlace(latitude, longitude) {
            fetch(`/place/nearby-places?latitude=${latitude}&longitude=${longitude}&radius=1.0`, {
                method: "GET",
                headers: { "Content-Type": "application/json" },
            })
            .then(response => response.json())
            .then(data => {
                if (data.data && data.data.length > 0) {
                    currentPlaces = data.data;
                    document.getElementById("place-count").textContent = `지금 내 주변 관광명소는 ${data.data.length}개`;
                    displayNearbyPlace(data.data);  // 기존 리스트 업데이트
                    updateMapMarkers(data.data);  // 지도에 마커 추가
                } else {
                    document.getElementById("place-count").textContent = "지금 내 주변 관광명소는 0개";
                    alert("주변에 관광명소가 없습니다.");
                }
            })
            .catch(error => console.error("Error fetching nearby places:", error));
        }

        // 지도에 명소 마커 추가 함수
        function updateMapMarkers(places) {
            // 이전 마커 제거
            markers.forEach(marker => marker.setMap(null));
            markers = [];

            if (!places || places.length === 0) {
                console.log("추가할 명소가 없습니다.");
                return;
            }

            places.forEach(place => {
                const marker = new naver.maps.Marker({
                    position: new naver.maps.LatLng(place.latitude, place.longitude),
                    map: map,
                    title: place.name
                });

                markers.push(marker);

                // 마커 클릭 시 상세 정보 출력
                naver.maps.Event.addListener(marker, "click", () => {
                    showPlaceDetails(place);
                });
            });
        }

        // 명소 리스트 표시 함수
        function displayNearbyPlace(places) {
            const placeList = document.getElementById("places-list");
            placeList.innerHTML = "";

            if (!places || places.length === 0) {
                placeList.innerHTML = "<p>주변 명소를 찾을 수 없습니다.</p>";
                return;
            }

            places.forEach(place => {
                const placeItem = document.createElement("div");
                placeItem.className = "place-item";
                placeItem.innerHTML = `
                    <h3>${place.name} <span class="favorite-icon">⭐</span></h3>
                    <p>${place.category || "정보 없음"} | ${place.address}</p>
                    <p>${place.description || "설명 없음"}</p>
                `;

                placeItem.addEventListener("click", () => showPlaceDetails(place));
                placeList.appendChild(placeItem);
            });

            // 명소 리스트를 보이도록 설정
            document.getElementById("places-list").style.display = "block";
            document.getElementById("place-details").style.display = "none"; // 상세 정보 숨김
        }

        // 명소 상세 정보 표시 함수 (마커 클릭 시)
        function showPlaceDetails(place) {
            const detailsContainer = document.getElementById("place-details");

            detailsContainer.innerHTML = `
                <h2>${place.name}</h2> | <p>${place.type}</p>
                <p>${place.address}</p>
                <p>${place.tel}</p>
            `;

            // 명소 리스트를 숨기고 상세 정보 표시
            document.getElementById("places-list").style.display = "none";
            detailsContainer.style.display = "block";

            // 기존 이벤트 리스너 제거 후 다시 등록 (중복 방지)
            document.removeEventListener("click", outsideClickListener);
            setTimeout(() => document.addEventListener("click", outsideClickListener), 0);
        }

        // 상세 정보 바 외부 클릭 시 닫기 이벤트 추가
        function outsideClickListener(event) {
            const detailsContainer = document.getElementById("place-details");
            if (!detailsContainer.contains(event.target)) {
                hidePlaceDetails();
                document.removeEventListener("click", outsideClickListener);
            }
        }

        // 명소 상세 정보 닫기 함수
        function hidePlaceDetails() {
            document.getElementById("places-list").style.display = "block"; // 기존 리스트 다시 표시
            document.getElementById("place-details").style.display = "none"; // 상세 정보 숨김
        }

        // 탭 버튼 클릭 시 스타일 변경 및 기존 리스트 표시
        function setActiveButton(buttonId) {
            document.querySelectorAll(".sidebar button").forEach(btn => btn.classList.remove("active"));
            document.getElementById(buttonId).classList.add("active");

            document.getElementById("places-list").style.display = "block"; // 기존 리스트 표시
            document.getElementById("place-details").style.display = "none"; // 상세 정보 숨김
        }

        // "모든 명소" 버튼 클릭 시 명소 검색 실행
        document.getElementById("all-places-btn").addEventListener("click", function () {
            setActiveButton("all-places-btn");
            fetchNearbyPlace(userLatitude, userLongitude);
        });

        // "맞춤 명소" 버튼 클릭 시 기본 리스트 유지
        document.getElementById("custom-places-btn").addEventListener("click", function () {
            setActiveButton("custom-places-btn");
            displayNearbyPlace([]);
        });

        // "즐겨찾기" 버튼 클릭 시 즐겨찾기 리스트 표시 (추후 구현 가능)
        document.getElementById("favorites-btn").addEventListener("click", function () {
            setActiveButton("favorites-btn");
            document.getElementById("places-list").innerHTML = "<p>즐겨찾기한 장소가 없습니다.</p>";
        });

        function handleLocationError(error) {
            alert("위치를 가져올 수 없습니다.");
        }

        initMap();
});
</script>

</body>
</html>
