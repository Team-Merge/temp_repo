#!/usr/bin/env sh

message="$(cat "$1")"
message=$(echo "$message" | tr -d '\r')  # Windows Ï∫êÎ¶¨ÏßÄ Î¶¨ÌÑ¥ Ï†úÍ±∞
echo "DEBUG: Commit message => $message"

headerPattern="^(feat|fix|build|chore|ci|docs|style|refactor|test|perf)(\([^\)]+\))?:[ ]{1}.{1,50}$"
bodyPattern="^(|.+)$"  # Allow single-line or empty Body
footerPattern="^(close|fixes|resolves) #[0-9]+$"  # Footer must match specific format

# Header, Body, Footer Î∂ÑÎ¶¨
header=$(echo "$message" | awk 'NR==1')  # Ï≤´ Î≤àÏß∏ Ï§Ñ: Header
body=$(echo "$message" | awk 'NR>1 && !/^close|fixes|resolves/ {print}')  # Ï§ëÍ∞Ñ Î∂ÄÎ∂Ñ: Body
footer=$(echo "$message" | awk '/^close|fixes|resolves/ {print}')  # ÎßàÏßÄÎßâ Î∂ÄÎ∂Ñ: Footer

# Í≥µÎ∞± Î∞è Ï§ÑÎ∞îÍøà Ï†úÍ±∞
header=$(echo "$header" | sed 's/^[ \t]*//;s/[ \t]*$//')
body=$(echo "$body" | sed 's/^[ \t]*//;s/[ \t]*$//')  # Í≥µÎ∞± Ï†úÍ±∞
footer=$(echo "$footer" | sed 's/^[ \t]*//;s/[ \t]*$//')  # Í≥µÎ∞± Ï†úÍ±∞

# echo "DEBUG: Header Value => [$header]"
# echo "DEBUG: Body Raw Value => [$body]"
# echo "DEBUG: Footer Value => [$footer]"
# echo "DEBUG: Body Pattern => $bodyPattern"
# echo "DEBUG: Footer Pattern => $footerPattern"

# Debugging the pattern matching
if [[ $footer =~ $footerPattern ]]; then
  echo "DEBUG: Footer matches the pattern!"
else
  echo "DEBUG: Footer does NOT match the pattern!"
fi

# Header Í≤ÄÏ¶ù
if ! [[ $header =~ $headerPattern ]]; then
  echo "=========================================================================="
  echo "======================   üö® WRONG COMMIT MESSAGE!   ======================"
  echo "=========================================================================="
  echo "== Header Format should be => ÌÉÄÏûÖ(Ïä§ÏΩîÌîÑ): Ï£ºÏ†ú                       =="
  echo "== Allowed Types: feat, fix, build, chore, ci, docs, style, refactor, test, perf =="
  echo "== EXAMPLE => feat: Î°úÍ∑∏Ïù∏ Í∏∞Îä• Ï∂îÍ∞Ä                                   =="
  echo "==            feat(auth): ÏÇ¨Ïö©Ïûê Ïù∏Ï¶ù Í∏∞Îä• Ï∂îÍ∞Ä                        =="
  echo "=========================================================================="
  exit 1
fi

# Body Í≤ÄÏ¶ù
if [ -n "$body" ] && ! [[ $body =~ $bodyPattern ]]; then
  echo "=========================================================================="
  echo "======================   üö® WRONG BODY FORMAT!    ========================"
  echo "=========================================================================="
  echo "== Body should provide detailed information (optional)                 =="
  echo "=========================================================================="
  exit 1
fi

# Footer Í≤ÄÏ¶ù
if [ -n "$footer" ] && ! [[ $footer =~ $footerPattern ]]; then
  echo "=========================================================================="
  echo "======================   üö® WRONG FOOTER FORMAT!  ========================"
  echo "=========================================================================="
  echo "== Footer should reference issues in the format: close #123, fixes #123 =="
  echo "=========================================================================="
  exit 1
fi

echo "=========================================================================="
echo "=======================      COMMIT CREATED!!      ======================="
echo "=========================================================================="
